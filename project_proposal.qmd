---
title: "STAT 331 Group A Project Proposal"
author: "Kevin Cisneros-Cuevas, Soren Fliegel, Chris Liu, Haoxian Liu"
format: 
  html:
    embed-resources: true
    code-tools: true
    toc: true
    number-sections: true
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
---

```{r setup}
library(tidyverse)
```

# Dataset Introduction

Sourced from "<https://www.gapminder.org/data/>"

The first dataset to explore is life expectancy, assembled by "gapminder.org" from various sources, with data ranging from 1800 to 2019, and projections until 2100 from the United Nations. A unit of observation is the number of years a newborn would be expected to live (given current the mortality rate) in a certain year and country. There are 196 listed countries, including Taiwan, Vatican City, and Palestine.

```{r}
life_expectancy <- read.csv("lex.csv")
```

Next, we will explore GDP (Gross Domestic Product) per capita, also assembled by "gapminder.org". GDP, like life expectancy, can be a way to compare the average standard of living across countries through how much economic output the average person creates. However, becasue the data viewed as an aggregate, GDP per capita does not account for inequality and differences that may occur through social stratification. A unit of observation is the GDP per capita in a country for a certain year in 2017 adjusted international dollars (which are equivalent to USD). This dataset includes blended data from 1800 to 2019, with projections again to 2100.

```{r}
gdp_per_capita <- read.csv("gdp_pcap.csv")
```

# Hypothesized Relationship between the Variables

The relationship between GDP per capita and life expectancy is something that has already been looked at in other studies and has been talked about as the Preston curve. According to research from the [Centre for Economic Policy Research (CEPR)](https://cepr.org/voxeu/columns/health-income-and-preston-curve) higher income levels usually lead to a increase in life expectancy. This is a relationship that we hope to see with our data although sometimes there are other factors like healthcare policies or political stability that can influence the relationship between our two variables.

# Cleaning the Data

The life expectancy table consists of data from year 1800-2100 which is a large range. Looking at the data, it seems like some countries in this table have missing values for multiple years, which could undesirable if we want to look for accurate trends. We could technically forward-fill or backward-fill missing data. However, it might also skew our results, so the best option in the end is to remove the countries with a lot of missing values. Let's say that countries with more than 20% missing values is bad data (20% is our threshold to reliable and representative data that minimizes biases introduced by imputation). Let also make the column names a little bit nicer by adding a prefix before the year instead of X. That way it is more descriptive.

```{r}

clean_life_expectancy <- life_expectancy |> 
  # calculating proportion of missing values for each row
  # source: https://www.statology.org/rowmeans-in-r/
  filter(rowMeans(across(-country, is.na)) <= 0.2) |> 
  # gsub: https://www.statology.org/gsub-r/
  # rename: https://dplyr.tidyverse.org/reference/rename.html
  rename_with(~ gsub("^X", "lex_", .), starts_with("X"))
```

Let's also rename the year columns in the `gdp_per_capita` table. Also, it seems like not every value in the data set is numeric. Some of the GDP per-capita values have "k" notation (e.g. 24.5k instead of 24500). So, we will need to convert them to actual numbers.

```{r}
# using a function :)
convert_k <- function(vec){
  has_k <- str_detect(vec, "k")
  vec_numeric <- as.numeric(str_replace(vec, "k", "")) 
  return(vec_numeric * ifelse(has_k, 1000, 1))   
}
```

```{r}
clean_gdp_per_capita <- gdp_per_capita |> 
  rename_with(~ gsub("^X", "gdp_per_capita_", .), starts_with("X")) |> 
  # all columns type -> numeric
  mutate(across(-country, convert_k))
```

Below, we have pivoted the `year` variable in both datasets to be a single column, as opposed to the dataframes having a column representing a year.

```{r}
long_life_expectancy <- clean_life_expectancy |> 
  pivot_longer(
    cols = starts_with("lex_"), 
    names_to = "year", 
    names_prefix = "lex_", 
    values_to = "life_expectancy"
  )

long_gdp_per_capita <- clean_gdp_per_capita |> 
  pivot_longer(
    cols = starts_with("gdp_per_capita_"), 
    names_to = "year", 
    names_prefix = "gdp_per_capita_", 
    values_to = "gdp_per_capita"
  )
```

Finally, we join both datasets by country and year.

```{r}
clean_long_df <- long_life_expectancy |> 
  inner_join(long_gdp_per_capita, 
             by = c("country", "year")) 
clean_long_df |>
  head(n = 5)
```
